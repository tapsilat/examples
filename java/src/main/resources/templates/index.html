<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tapsilat Go Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        overflow-x: hidden;
      }
      .sidebar {
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        width: 260px;
        background-color: #2c3e50;
        color: #ecf0f1;
        padding-top: 20px;
        transition: all 0.3s;
        z-index: 1000;
      }
      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        margin: 5px 15px;
        border-radius: 5px;
        cursor: pointer;
        padding: 10px 15px;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        color: white;
        background-color: #34495e;
        transform: translateX(5px);
      }
      .sidebar .brand {
        font-size: 1.5rem;
        font-weight: bold;
        padding: 0 20px;
        margin-bottom: 30px;
        display: block;
        color: white;
        text-decoration: none;
      }
      .main-content {
        margin-left: 260px;
        padding: 30px;
      }
      .copy-btn {
        color: #6c757d;
        cursor: pointer;
        transition: color 0.2s;
      }
      .copy-btn:hover {
        color: #0d6efd;
      }
      .card {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: none;
        margin-bottom: 20px;
      }
      .tab-view {
        display: none;
        animation: fadeIn 0.3s;
      }
      .tab-view.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Shop Wizard Styles within Shop View */
      .shop-step {
        display: none;
      }
      .shop-step.active {
        display: block;
      }
      .shop-indicator {
        display: flex;
        margin-bottom: 20px;
        justify-content: center;
      }
      .shop-ind-item {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        font-weight: bold;
        color: #777;
      }
      .shop-ind-item.active {
        background: #0d6efd;
        color: white;
      }

      /* Console Style */
      #webhook-console {
        background: #1e1e1e;
        color: #00ff00;
        font-family: "Courier New", Courier, monospace;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        border-radius: 5px;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <nav class="sidebar">
      <a href="#" class="brand"><i class="fas fa-boxes"></i> Tapsilat</a>
      <div class="nav flex-column">
        <a class="nav-link active" onclick="switchView('shop', this)"
          ><i class="fas fa-shopping-cart me-2"></i> New Order</a
        >
        <a class="nav-link" onclick="switchView('orders', this)"
          ><i class="fas fa-list me-2"></i> Order List</a
        >
        <a class="nav-link" onclick="switchView('subscriptions', this)"
          ><i class="fas fa-sync me-2"></i> Subscriptions</a
        >
        <a class="nav-link" onclick="switchView('terms', this)"
          ><i class="fas fa-file-invoice-dollar me-2"></i> Payment Terms</a
        >
        <a class="nav-link" onclick="switchView('submerchants', this)"
          ><i class="fas fa-store me-2"></i> Submerchants</a
        >
        <a class="nav-link" onclick="switchView('organization', this)"
          ><i class="fas fa-building me-2"></i> Organization</a
        >
        <a class="nav-link" onclick="switchView('webhooks', this)"
          ><i class="fas fa-broadcast-tower me-2"></i> Webhook Monitor</a
        >
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- SHOP VIEW -->
      <div id="view-shop" class="tab-view active">
        <h2>Create New Order</h2>
        <div class="card p-4">
          <div class="shop-indicator">
            <div class="shop-ind-item active" id="si-1">1</div>
            <div class="shop-ind-item" id="si-2">2</div>
            <div class="shop-ind-item" id="si-3">3</div>
          </div>

          <!-- 1. Cart -->
          <!-- 1. Cart & Options -->
          <div id="shop-step-1" class="shop-step active">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4>Order Details & Settings</h4>
              <button
                class="btn btn-sm btn-outline-secondary"
                onclick="randomizeShopValues()"
              >
                <i class="fas fa-random"></i> Randomize
              </button>
            </div>

            <!-- Core Settings -->
            <div class="card mb-3">
              <div class="card-header bg-light">General Settings</div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Conversation ID</label>
                    <input type="text" class="form-control" id="shop-conv-id" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="shop-desc" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Locale</label>
                    <select class="form-select" id="shop-locale">
                      <option value="tr">TR</option>
                      <option value="en">EN</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Currency</label>
                    <select class="form-select" id="shop-currency">
                      <option value="TRY">TRY</option>
                      <option value="USD">USD</option>
                      <option value="EUR">EUR</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">3D Secure</label>
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="shop-3d"
                        checked
                      />
                      <label class="form-check-label">Force 3D</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Installment</label>
                    <input
                      type="number"
                      class="form-control"
                      id="shop-installment-count"
                      value="1"
                    />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">All Pay Methods</label>
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="shop-pm"
                        checked
                      />
                      <label class="form-check-label">Enable All</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Advanced Settings -->
            <div class="card mb-3">
              <div class="card-header bg-light">Advanced Configuration</div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label">Enabled Installments</label>
                    <div
                      id="shop-installments-checks"
                      class="d-flex gap-3 flex-wrap"
                    >
                      <!-- JS Injected -->
                    </div>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Payment Options</label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          value="card"
                          id="po-card"
                          checked
                        />
                        <label class="form-check-label" for="po-card"
                          >Card</label
                        >
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          value="bank_transfer"
                          id="po-bank"
                          checked
                        />
                        <label class="form-check-label" for="po-bank"
                          >Bank Transfer</label
                        >
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Metadata (Key:Value)</label>
                    <div id="shop-metadata-list" class="mb-2"></div>
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      onclick="addMetadataRow()"
                    >
                      + Add Metadata
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-3">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <span>Basket Items</span>
                <button
                  class="btn btn-sm btn-outline-primary"
                  onclick="addCartItem()"
                >
                  + Add Item
                </button>
              </div>
              <div class="card-body p-0">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Product Name</th>
                      <th style="width: 120px">Price</th>
                      <th style="width: 80px">Qty</th>
                      <th style="width: 50px"></th>
                    </tr>
                  </thead>
                  <tbody id="cart-items-body">
                    <!-- Items injected here -->
                  </tbody>
                </table>
              </div>
            </div>

            <div class="text-end border-top pt-3">
              <h4 class="mb-3">
                Total: <span id="cart-total-display">₺0.00</span>
              </h4>
              <button class="btn btn-primary" onclick="validateStep1()">
                Proceed to Address
              </button>
            </div>
          </div>

          <!-- 2. Address -->
          <div id="shop-step-2" class="shop-step">
            <h4>Billing Information</h4>
            <form id="billing-form">
              <div class="row">
                <div class="col-md-6 mb-2">
                  <input
                    class="form-control"
                    name="contact_name"
                    value="John Doe"
                    placeholder="Name"
                  />
                </div>
                <div class="col-md-6 mb-2">
                  <input
                    class="form-control"
                    name="email"
                    value="john@example.com"
                    placeholder="Email"
                  />
                </div>
                <div class="col-md-6 mb-2">
                  <input
                    class="form-control"
                    name="contact_phone"
                    value="5551234567"
                    placeholder="Phone"
                  />
                </div>
                <div class="col-md-6 mb-2">
                  <input
                    class="form-control"
                    name="vat_number"
                    value="11111111111"
                    placeholder="VAT/Identity"
                  />
                </div>
                <div class="col-12 mb-2">
                  <input
                    class="form-control"
                    name="address"
                    value="Besiktas Main St"
                    placeholder="Address"
                  />
                </div>
                <div class="col-6 mb-2">
                  <input
                    class="form-control"
                    name="city"
                    value="Istanbul"
                    placeholder="City"
                  />
                </div>
                <div class="col-6 mb-2">
                  <input
                    class="form-control"
                    name="zip_code"
                    value="34000"
                    placeholder="Zip"
                  />
                </div>
                <div class="col-12 mt-2">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="same-address"
                      checked
                    />
                    <label class="form-check-label" for="same-address">
                      Shipping address same as billing
                    </label>
                  </div>
                </div>
              </div>
            </form>
            <button class="btn btn-secondary" onclick="toShopStep(1)">
              Back
            </button>
            <button class="btn btn-primary" onclick="toShopStep(3)">
              Proceed to Payment
            </button>
          </div>

          <!-- 3. Payment -->
          <div id="shop-step-3" class="shop-step">
            <h4>Payment Options</h4>
            <div class="mb-3">
              <label>Installments:</label>
              <select class="form-select" id="shop-installment">
                <option value="1">Cash (1)</option>
                <option value="2">2 Installments</option>
                <option value="3">3 Installments</option>
                <option value="6">6 Installments</option>
                <option value="12">12 Installments</option>
              </select>
            </div>
            <button class="btn btn-secondary" onclick="toShopStep(2)">
              Back
            </button>
            <button class="btn btn-success" onclick="createOrder()">
              Complete Order
            </button>
          </div>
        </div>
      </div>

      <!-- ORDERS VIEW -->
      <div id="view-orders" class="tab-view">
        <h2 class="d-flex justify-content-between align-items-center">
          Order Management
          <button class="btn btn-primary btn-sm" onclick="fetchOrders()">
            Refresh List
          </button>
        </h2>

        <!-- Filter Bar -->
        <div class="card p-3 mb-3 bg-light">
          <form
            onsubmit="
              event.preventDefault();
              fetchOrders(1);
            "
          >
            <div class="row g-2">
              <div class="col-md-3">
                <label>Date Range</label>
                <div class="input-group">
                  <input
                    type="date"
                    class="form-control form-control-sm"
                    id="filter-start"
                  />
                  <input
                    type="date"
                    class="form-control form-control-sm"
                    id="filter-end"
                  />
                </div>
              </div>
              <div class="col-md-2">
                <label>Org ID</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="filter-org"
                  placeholder="Organization ID"
                />
              </div>
              <div class="col-md-2">
                <label>Related Ref ID</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="filter-ref"
                  placeholder="Ref ID"
                />
              </div>
              <div class="col-md-2">
                <label>Page</label>
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    class="form-control"
                    id="order-page"
                    value="1"
                    min="1"
                  />
                  <select class="form-select" id="order-per-page">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-secondary btn-sm w-100">
                  Apply Filters
                </button>
              </div>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Reference ID</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="orders-table-body">
                  <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                      Loading...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-between">
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="changeOrderPage(-1)"
            >
              Previous
            </button>
            <span id="order-page-info">Page 1</span>
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="changeOrderPage(1)"
            >
              Next
            </button>
          </div>
        </div>

        <!-- Detail Modal -->
        <div class="modal fade" id="orderDetailModal" tabindex="-1">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  Order Details:
                  <span
                    id="detail-id"
                    class="text-primary font-monospace"
                  ></span>
                </h5>
                <button
                  class="btn btn-sm btn-outline-secondary ms-2"
                  onclick="copyText('detail-id')"
                >
                  <i class="fas fa-copy"></i>
                </button>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  data-bs-target="#orderDetailModal"
                ></button>
              </div>
              <div class="modal-body">
                <!-- Management Actions -->
                <div
                  class="alert alert-light border d-flex gap-2 justify-content-end mb-4"
                >
                  <button
                    class="btn btn-danger btn-sm"
                    onclick="actionOrder('cancel')"
                  >
                    <i class="fas fa-ban"></i> Cancel Order
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    onclick="actionOrder('refund')"
                  >
                    <i class="fas fa-undo"></i> Refund Order
                  </button>
                  <button
                    class="btn btn-dark btn-sm"
                    onclick="actionOrder('terminate')"
                  >
                    <i class="fas fa-stop-circle"></i> Terminate
                  </button>
                  <button
                    class="btn btn-info btn-sm text-white"
                    onclick="triggerManualCallback()"
                  >
                    <i class="fas fa-bell"></i> Manual Callback
                  </button>
                </div>

                <div class="row">
                  <!-- Basic Info -->
                  <div class="col-md-6 mb-4">
                    <h6>Basic Info</h6>
                    <table class="table table-sm table-bordered">
                      <tbody id="detail-basic"></tbody>
                    </table>
                  </div>
                  <!-- Raw Data -->
                  <div class="col-md-6 mb-4">
                    <h6>Raw Data</h6>
                    <pre
                      id="detail-raw"
                      style="max-height: 200px; font-size: 0.8em"
                    ></pre>
                  </div>
                </div>

                <!-- Transactions -->
                <h6 class="border-bottom pb-2 mt-2">Transactions</h6>
                <div id="detail-transactions" class="mb-4 text-muted">
                  Loading transactions...
                </div>

                <!-- Terms -->
                <h6 class="border-bottom pb-2 mt-2">Payment Terms</h6>
                <div class="text-end mb-2">
                  <button
                    class="btn btn-sm btn-success"
                    data-bs-toggle="collapse"
                    data-bs-target="#new-term-form"
                  >
                    + Add Term
                  </button>
                </div>
                <div class="collapse mb-3" id="new-term-form">
                  <div class="card card-body bg-light">
                    <form onsubmit="createTerm(event)">
                      <div class="input-group">
                        <input
                          type="number"
                          name="amount"
                          class="form-control"
                          placeholder="Amount"
                          step="0.01"
                          required
                        />
                        <input
                          type="date"
                          name="due_date"
                          class="form-control"
                          required
                        />
                        <button class="btn btn-primary">Create</button>
                      </div>
                    </form>
                  </div>
                </div>
                <div id="detail-terms" class="mb-4 text-muted">
                  Fetch terms manually if needed (API limited on pure list)
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SUBSCRIPTIONS VIEW -->
      <div id="view-subscriptions" class="tab-view">
        <h2>Subscriptions</h2>
        <div class="row">
          <div class="col-md-4">
            <div class="card p-3">
              <h4>New Subscription</h4>
              <form onsubmit="createSubscription(event)">
                <input
                  class="form-control mb-2"
                  name="name"
                  value="Gold Plan"
                  placeholder="Title"
                  required
                />
                <input
                  type="number"
                  class="form-control mb-2"
                  name="amount"
                  value="49.90"
                  step="0.01"
                  placeholder="Amount"
                  required
                />
                <select class="form-select mb-3" name="period">
                  <option value="1">Monthly</option>
                  <option value="12">Yearly</option>
                </select>
                <button class="btn btn-primary w-100">Create & Pay</button>
              </form>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card p-3">
              <h4>
                List
                <button
                  class="btn btn-sm btn-light float-end"
                  onclick="fetchSubscriptions()"
                >
                  Refresh
                </button>
              </h4>
              <div id="subs-list" class="list-group list-group-flush">
                <div class="text-center py-3">Loading...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TERMS VIEW (Direct) -->
      <div id="view-terms" class="tab-view">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Payment Terms Scanner</h2>
          <button class="btn btn-primary" onclick="fetchTerms()">
            Scan Last 100 Orders
          </button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Term Ref ID</th>
                    <th>Order Ref ID</th>
                    <th>Amount</th>
                    <th>Required</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="terms-table-body">
                  <tr>
                    <td colspan="6" class="text-center">
                      Click "Scan" to load terms from recent orders.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- SUBMERCHANTS VIEW -->
      <div id="view-submerchants" class="tab-view">
        <h2 class="d-flex justify-content-between align-items-center mb-3">
          Submerchants
          <button class="btn btn-primary btn-sm" onclick="fetchSubmerchants()">
            Refresh List
          </button>
        </h2>
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Submerchant ID</th>
                    <th>Type</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="submerchants-table-body">
                  <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                      Loading...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ORGANIZATION VIEW -->
      <div id="view-organization" class="tab-view">
        <h2 class="mb-3">Organization Settings</h2>
        <div class="card">
          <div class="card-body">
            <div id="org-settings-content">Loading settings...</div>
            <button
              class="btn btn-primary mt-3"
              onclick="fetchOrganizationSettings()"
            >
              Refresh Settings
            </button>
          </div>
        </div>
      </div>

      <!-- WEBHOOK MONITOR -->
      <div id="view-webhooks" class="tab-view">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Webhook Monitor</h2>
          <button class="btn btn-secondary" onclick="fetchWebhooks()">
            <i class="fas fa-sync-alt"></i> Refresh List
          </button>
        </div>
        <p class="text-muted">
          Webhooks are saved to `webhooks/` folder. Click refresh to list them.
        </p>

        <div class="card">
          <div class="card-header bg-dark text-white">Received Callbacks</div>
          <div
            class="card-body p-0"
            id="webhook-list"
            style="height: 500px; overflow-y: auto"
          >
            <div class="p-4 text-center text-muted">
              Click Refresh to load data.
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- UTILS ---
      const show = (id) =>
        document.getElementById(id).classList.remove("d-none");
      const hide = (id) => document.getElementById(id).classList.add("d-none");
      const copyText = (id) => {
        const text =
          document.getElementById(id).innerText ||
          document.getElementById(id).value;
        navigator.clipboard.writeText(text);
        alert("Copied: " + text);
      };

      // --- NAVIGATION ---
      function switchView(viewName, element) {
        // Handled by overriding function at bottom, but keep structure for clarity
        originalSwitchView(viewName, element);
      }

      // --- SHOP LOGIC ---
      let cart = [];
      let metadataCount = 0;

      function toShopStep(step) {
        document
          .querySelectorAll(".shop-step")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".shop-ind-item")
          .forEach((el) => el.classList.remove("active"));

        document.getElementById("shop-step-" + step).classList.add("active");
        for (let i = 1; i <= step; i++) {
          document.getElementById("si-" + i).classList.add("active");
        }
      }

      function addCartItem() {
        const id = Math.floor(Math.random() * 1000);
        const item = {
          id: id,
          name: "Product " + id,
          price: (Math.random() * 100 + 10).toFixed(2),
          quantity: 1,
        };
        cart.push(item);
        renderCart();
      }

      function renderCart() {
        const tbody = document.getElementById("cart-items-body");
        let total = 0;
        tbody.innerHTML = cart
          .map((item, index) => {
            total += item.price * item.quantity;
            return `
            <tr>
                <td>${item.name}</td>
                <td>₺${item.price}</td>
                <td><input type="number" class="form-control form-control-sm" value="${item.quantity}" onchange="updateQty(${index}, this.value)"></td>
                <td><button class="btn btn-sm btn-danger" onclick="removeCartItem(${index})"><i class="fas fa-trash"></i></button></td>
            </tr>
        `;
          })
          .join("");
        document.getElementById("cart-total-display").innerText =
          "₺" + total.toFixed(2);
      }

      function updateQty(index, qty) {
        cart[index].quantity = parseInt(qty);
        renderCart();
      }

      function removeCartItem(index) {
        cart.splice(index, 1);
        renderCart();
      }

      function randomizeShopValues() {
        document.getElementById("shop-conv-id").value =
          "CONV_" + Math.floor(Date.now() / 1000);
        document.getElementById("shop-desc").value =
          "Random Order " + Math.random().toString(36).substring(7);
        addCartItem();
        addCartItem();
      }

      function addMetadataRow() {
        const div = document.createElement("div");
        div.className = "input-group mb-2";
        div.innerHTML = `
        <input type="text" class="form-control form-control-sm meta-key" placeholder="Key">
        <input type="text" class="form-control form-control-sm meta-val" placeholder="Value">
        <button class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">x</button>
      `;
        document.getElementById("shop-metadata-list").appendChild(div);
      }

      // Init logic
      window.addEventListener("DOMContentLoaded", () => {
        // Checkboxes for installments
        const checks = [1, 2, 3, 6, 9, 12]
          .map(
            (i) => `
        <div class="form-check">
            <input class="form-check-input inst-check" type="checkbox" value="${i}" id="inst-${i}" checked>
            <label class="form-check-label" for="inst-${i}">${i}</label>
        </div>
        `,
          )
          .join("");
        document.getElementById("shop-installments-checks").innerHTML = checks;
        randomizeShopValues();
      });

      function validateStep1() {
        if (cart.length === 0) return alert("Cart is empty!");
        toShopStep(2);
      }

      async function createOrder() {
        if (cart.length === 0) return alert("Cart is empty!");

        const billingForm = new FormData(
          document.getElementById("billing-form"),
        );
        const billing = Object.fromEntries(billingForm.entries());

        const enabledInst = Array.from(
          document.querySelectorAll(".inst-check:checked"),
        ).map((cb) => parseInt(cb.value));
        const paymentOptions = [];
        if (document.getElementById("po-card").checked)
          paymentOptions.push("card");
        if (document.getElementById("po-bank").checked)
          paymentOptions.push("bank_transfer");

        const metadata = [];
        document
          .querySelectorAll("#shop-metadata-list .input-group")
          .forEach((row) => {
            const key = row.querySelector(".meta-key").value;
            const val = row.querySelector(".meta-val").value;
            if (key) metadata.push({ key, value: val });
          });

        const payload = {
          conversation_id: document.getElementById("shop-conv-id").value,
          description: document.getElementById("shop-desc").value,
          locale: document.getElementById("shop-locale").value,
          currency: document.getElementById("shop-currency").value,
          three_d_force: document.getElementById("shop-3d").checked,
          installment: parseInt(
            document.getElementById("shop-installment").value,
          ),
          payment_methods: document.getElementById("shop-pm").checked,
          enabled_installments: enabledInst,
          payment_options: paymentOptions,
          cart: cart,
          billing: billing,
          same_address: document.getElementById("same-address").checked,
          metadata: metadata,
        };

        try {
          const res = await fetch("/api/order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();

          if (data.success) {
            if (data.checkout_url) {
              window.open(data.checkout_url, "_blank");
            } else {
              alert("Order created but no checkout URL received.");
            }
            // Reset
            cart = [];
            renderCart();
            toShopStep(1);
            alert("Order Created! Ref: " + data.reference_id);
          } else {
            alert("Error: " + data.error);
          }
        } catch (e) {
          alert("Network Error: " + e);
        }
      }

      // --- ORDERS LIST & DETAIL ---
      let currentOrderPage = 1;

      async function fetchOrders(pageOverride) {
        if (pageOverride) currentOrderPage = pageOverride;
        const perPage = document.getElementById("order-per-page").value;
        const start = document.getElementById("filter-start").value;
        const end = document.getElementById("filter-end").value;
        const org = document.getElementById("filter-org").value;
        const ref = document.getElementById("filter-ref").value;

        let query = `?page=${currentOrderPage}&per_page=${perPage}`;
        if (start) query += `&start_date=${start}`;
        if (end) query += `&end_date=${end}`;
        if (org) query += `&organization_id=${org}`;
        if (ref) query += `&related_reference_id=${ref}`;

        const tbody = document.getElementById("orders-table-body");
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

        try {
          const res = await fetch("/api/order/list" + query);
          const data = await res.json();

          // Standardize response: Go returns {items: [...], meta: ...}, Java might return raw list or map
          // Assuming standardized generic response structure for list queries
          // The Go code returns `PaginatedData` struct which has `Items` inside.
          // Let's assume the API returns { items: [] } or just [] or a wrapper.
          // Adjust based on actual API response structure observed.
          // Most Tapsilat endpoints return { items: [...], ... }

          const items = data.items || data.data || []; // fallback

          if (items.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="text-center">No orders found</td></tr>';
            return;
          }

          tbody.innerHTML = items
            .map(
              (o) => `
            <tr>
                <td class="font-monospace"><a href="#" onclick="showOrderDetail('${o.reference_id}')">${o.reference_id}</a></td>
                <td>${o.created_at || "-"}</td>
                <td>${o.amount} ${o.currency}</td>
                <td><span class="badge bg-secondary">${o.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="showOrderDetail('${o.reference_id}')"><i class="fas fa-eye"></i></button>
                </td>
            </tr>
        `,
            )
            .join("");

          document.getElementById("order-page-info").innerText =
            "Page " + currentOrderPage;
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-danger">Error loading orders</td></tr>';
        }
      }

      function changeOrderPage(delta) {
        if (currentOrderPage + delta < 1) return;
        currentOrderPage += delta;
        fetchOrders();
      }

      async function showOrderDetail(refId) {
        const modal = new bootstrap.Modal(
          document.getElementById("orderDetailModal"),
        );
        document.getElementById("detail-id").innerText = refId;
        document.getElementById("detail-basic").innerHTML = "Loading...";
        document.getElementById("detail-raw").innerText = "";
        document.getElementById("detail-transactions").innerHTML = "Loading...";
        modal.show();

        try {
          const res = await fetch("/api/order/details/" + refId);
          const data = await res.json();

          // Render basic info
          const basic = `
            <tr><th>Status</th><td>${data.status}</td></tr>
            <tr><th>Amount</th><td>${data.amount} ${data.currency}</td></tr>
            <tr><th>Date</th><td>${data.created_at}</td></tr>
            <tr><th>Installment</th><td>${data.installment}</td></tr>
            <tr><th>Buyer</th><td>${data.buyer ? data.buyer.name : "-"}</td></tr>
        `;
          document.getElementById("detail-basic").innerHTML = basic;
          document.getElementById("detail-raw").innerText = JSON.stringify(
            data,
            null,
            2,
          );

          // Fetch Transactions
          fetchTransactions(refId);
          // Fetch Terms (API doesn't have list-by-order easily globally, but we can verify if attached in details)
          // For this example, we leave terms section static or manual fetch
        } catch (e) {
          document.getElementById("detail-basic").innerText = "Error: " + e;
        }
      }

      async function fetchTransactions(refId) {
        try {
          const res = await fetch("/api/order/transactions/" + refId);
          const data = await res.json();
          const items = data.items || data || [];
          if (items.length === 0) {
            document.getElementById("detail-transactions").innerText =
              "No transactions.";
            return;
          }
          const html =
            `<table class="table table-sm text-muted"><thead><tr><th>ID</th><th>Type</th><th>Status</th><th>Amount</th><th>Date</th></tr></thead><tbody>` +
            items
              .map(
                (t) =>
                  `<tr><td>${t.transaction_id}</td><td>${t.type}</td><td>${t.status}</td><td>${t.amount}</td><td>${t.created_at}</td></tr>`,
              )
              .join("") +
            `</tbody></table>`;
          document.getElementById("detail-transactions").innerHTML = html;
        } catch (e) {
          document.getElementById("detail-transactions").innerText =
            "Failed to load transactions.";
        }
      }

      async function actionOrder(action) {
        const refId = document.getElementById("detail-id").innerText;
        if (!confirm(`Are you sure you want to ${action} order ${refId}?`))
          return;

        const endpoint =
          action === "cancel"
            ? "/api/order/cancel"
            : action === "refund"
              ? "/api/order/refund"
              : "/api/order/terminate";

        // For refund, maybe ask amount?
        let body = { reference_id: refId };
        if (action === "refund") {
          const amount = prompt(
            "Enter amount for partial refund (leave empty for full):",
          );
          if (amount) body.amount = amount; // Go backend expects amount string for parsing
        }

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          alert(action.toUpperCase() + " Result: " + JSON.stringify(data));
          // Refresh details
          showOrderDetail(refId);
        } catch (e) {
          alert("Error: " + e);
        }
      }

      async function createTerm(e) {
        e.preventDefault();
        const form = e.target;
        const refId = document.getElementById("detail-id").innerText;
        const amount = form.elements["amount"].value;
        const date = form.elements["due_date"].value;

        try {
          const res = await fetch("/api/term/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              reference_id: refId,
              amount: parseFloat(amount),
              due_date: date,
            }),
          });
          const data = await res.json();
          alert("Term Created: " + JSON.stringify(data));
          form.reset();
        } catch (err) {
          alert("Error: " + err);
        }
      }

      async function deleteTerm(orderId, termId) {
        if (!confirm("Delete term " + termId + "?")) return;
        try {
          const res = await fetch("/api/term/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              order_id: orderId,
              term_reference_id: termId,
            }),
          });
          const data = await res.json();
          alert("Result: " + JSON.stringify(data));
          fetchTerms(); // Refresh list if looking at table
        } catch (e) {
          alert("Error: " + e);
        }
      }

      // --- SUBSCRIPTIONS ---
      async function createSubscription(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const payload = Object.fromEntries(formData.entries());
        // Add fake user data
        payload.subscriber_email = "sub@example.com";
        payload.subscriber_phone = "5551112233";

        try {
          const res = await fetch("/api/subscription", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (data.success) {
            if (data.checkout_url) window.open(data.checkout_url, "_blank");
            alert("Subscription Created: " + data.reference_id);
            fetchSubscriptions();
          } else {
            alert("Error: " + data.error);
          }
        } catch (e) {
          alert("Error: " + e);
        }
      }

      async function fetchSubscriptions() {
        const list = document.getElementById("subs-list");
        list.innerHTML = "Loading...";
        try {
          const res = await fetch("/api/subscription/list");
          const data = await res.json();
          const items = data.items || [];
          if (items.length === 0) {
            list.innerHTML = "No subscriptions.";
            return;
          }
          list.innerHTML = items
            .map(
              (s) => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>${s.reference_id}</strong><br>
                    <small>${s.status} - ${s.amount} ${s.currency}</small>
                </div>
                <button class="btn btn-sm btn-danger" onclick="cancelSubscription('${s.reference_id}')">Cancel</button>
            </div>
        `,
            )
            .join("");
        } catch (e) {
          list.innerHTML = "Error loading list.";
        }
      }

      async function cancelSubscription(subId) {
        if (!confirm("Cancel subscription?")) return;
        try {
          const res = await fetch("/api/subscription/cancel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ subscription_id: subId }),
          });
          const data = await res.json();
          alert("Result: " + JSON.stringify(data));
          fetchSubscriptions();
        } catch (e) {
          alert("Error: " + e);
        }
      }

      // --- TERMS SCANNER ---
      async function fetchTerms() {
        const tbody = document.getElementById("terms-table-body");
        tbody.innerHTML =
          '<tr><td colspan="6" class="text-center">Scanning last 100 orders for terms...</td></tr>';

        try {
          // fetch last 100 orders to find terms
          const res = await fetch("/api/order/list?per_page=100");
          const json = await res.json();
          let termsFound = [];

          if (json.rows) {
            json.rows.forEach((o) => {
              if (o.payment_terms && o.payment_terms.length > 0) {
                o.payment_terms.forEach((t) =>
                  termsFound.push({ order: o.reference_id, term: t }),
                );
              }
            });
          }

          renderTermsTable(termsFound);
        } catch (e) {
          console.error(e);
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Scan failed: ${e.message}</td></tr>`;
        }
      }

      function renderTermsTable(terms) {
        const tbody = document.getElementById("terms-table-body");
        if (!tbody) return;

        if (terms.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center text-muted">No payment terms found in recent orders.</td></tr>';
          return;
        }

        tbody.innerHTML = terms
          .map((t) => {
            return `<tr>
                      <td class="font-monospace">${
                        t.term.term_reference_id || "-"
                      }</td>
                      <td class="font-monospace"><a href="#" onclick="showOrderDetail('${
                        t.order
                      }')">${t.order}</a></td>
                      <td>${t.term.amount || "-"}</td>
                      <td>${
                        t.term.required
                          ? '<span class="badge bg-danger">Required</span>'
                          : '<span class="badge bg-secondary">Optional</span>'
                      }</td>
                      <td>${t.term.status || "-"}</td>
                      <td>
                          <button class="btn btn-sm btn-primary" onclick="updateTerm('${t.term.term_reference_id}')">Update</button>
                          <button class="btn btn-sm btn-warning" onclick="refundTerm('${t.order}', '${t.term.term_reference_id}')">Refund</button>
                          <button class="btn btn-sm btn-danger" onclick="deleteTerm('${
                            t.order
                          }', '${t.term.term_reference_id}')">Delete</button>
                      </td>
                   </tr>`;
          })
          .join("");
      }

      // --- WEBHOOK MONITOR ---
      async function fetchWebhooks() {
        const container = document.getElementById("webhook-list");
        container.innerHTML =
          '<div class="p-4 text-center">Loading webhooks...</div>';
        try {
          const res = await fetch("/api/webhooks");
          const logs = await res.json();

          if (logs.length === 0) {
            container.innerHTML =
              '<div class="p-4 text-center text-muted">No webhooks recorded yet.</div>';
            return;
          }

          container.innerHTML = logs
            .map(
              (log) => `
            <div class="border-bottom p-2 webhook-item">
                <div class="d-flex justify-content-between">
                    <span class="text-primary font-monospace small">${
                      log.filename
                    }</span>
                    <button class="btn btn-sm btn-link p-0" onclick="this.parentElement.nextElementSibling.classList.toggle('d-none')">Toggle</button>
                </div>
                <div class="mt-2 d-none">
                    <pre class="bg-light p-2 small border rounded mb-0">${JSON.stringify(
                      log.content,
                      null,
                      2,
                    )}</pre>
                </div>
            </div>
        `,
            )
            .join("");
        } catch (e) {
          container.innerHTML =
            '<div class="p-4 text-center text-danger">Failed to load webhooks</div>';
        }
      }

      // --- SUBMERCHANTS ---
      async function fetchSubmerchants() {
        const tbody = document.getElementById("submerchants-table-body");
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

        try {
          const res = await fetch("/api/order/submerchants");
          const data = await res.json();

          if (data.items && data.items.length > 0) {
            tbody.innerHTML = data.items
              .map(
                (item) => `
                <tr>
                    <td>${item.sub_merchant_external_id}</td>
                    <td>${item.sub_merchant_type}</td>
                    <td>${item.legal_name || item.alias}</td>
                    <td>${item.email}</td>
                    <td>${item.status}</td>
                </tr>
            `,
              )
              .join("");
          } else {
            tbody.innerHTML =
              '<tr><td colspan="5" class="text-center">No submerchants found</td></tr>';
          }
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-danger">Error loading submerchants</td></tr>';
        }
      }

      // --- ORGANIZATION ---
      async function fetchOrganizationSettings() {
        const container = document.getElementById("org-settings-content");
        container.innerHTML = "Loading...";
        try {
          const res = await fetch("/api/organization/settings");
          const data = await res.json();
          container.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } catch (e) {
          container.innerHTML = "Error loading settings";
        }
      }

      // --- ORDER ACTIONS EXTENDED ---
      async function triggerManualCallback() {
        const refId = document.getElementById("detail-id").innerText;
        // Simple prompt for now, or extract conv ID from details if stored
        // Assuming we just trigger without specific conv ID or simple prompt
        if (!confirm("Trigger Manual Callback for " + refId + "?")) return;

        try {
          const res = await fetch("/api/order/manual-callback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reference_id: refId }),
          });
          const data = await res.json();
          alert("Callback Triggered: " + JSON.stringify(data));
        } catch (e) {
          alert("Error: " + e);
        }
      }

      // --- TERMS ACTIONS ---
      async function updateTerm(termRefId) {
        const amount = prompt("New Amount for Term " + termRefId + ":");
        if (!amount) return;

        try {
          const res = await fetch("/api/term/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              term_reference_id: termRefId,
              amount: parseFloat(amount),
            }),
          });
          const data = await res.json();
          alert("Update Result: " + JSON.stringify(data));
          fetchTerms(); // Refresh
        } catch (e) {
          alert("Error: " + e);
        }
      }

      async function refundTerm(orderRefId, termRefId) {
        const amount = prompt("Refund Amount for Term " + termRefId + ":");
        if (!amount) return;

        try {
          const res = await fetch("/api/term/refund", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              order_reference_id: orderRefId, // Need order ref id, usually from context
              term_reference_id: termRefId,
              amount: parseFloat(amount),
            }),
          });
          const data = await res.json();
          alert("Refund Result: " + JSON.stringify(data));
          fetchTerms();
        } catch (e) {
          alert("Error: " + e);
        }
      }

      // Hook into view switch to auto-load
      const originalSwitchView = window.switchView;
      window.switchView = function (viewName, el) {
        // Default logic
        document
          .querySelectorAll(".tab-view")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".nav-link")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById("view-" + viewName).classList.add("active");
        if (el) el.classList.add("active");

        // specific loads
        if (viewName === "organization") fetchOrganizationSettings();
        if (viewName === "submerchants") fetchSubmerchants();
        if (viewName === "webhooks") fetchWebhooks();
      };
    </script>
  </body>
</html>
