<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tapsilat Python Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        overflow-x: hidden;
      }
      .sidebar {
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        width: 260px;
        background-color: #2c3e50;
        color: #ecf0f1;
        padding-top: 20px;
        transition: all 0.3s;
        z-index: 1000;
      }
      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        margin: 5px 15px;
        border-radius: 5px;
        cursor: pointer;
        padding: 10px 15px;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        color: white;
        background-color: #34495e;
        transform: translateX(5px);
      }
      .sidebar .brand {
        font-size: 1.5rem;
        font-weight: bold;
        padding: 0 20px;
        margin-bottom: 30px;
        display: block;
        color: white;
        text-decoration: none;
      }
      .main-content {
        margin-left: 260px;
        padding: 30px;
      }
      .copy-btn {
        color: #6c757d;
        cursor: pointer;
        transition: color 0.2s;
      }
      .copy-btn:hover {
        color: #0d6efd;
      }
      .card {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: none;
        margin-bottom: 20px;
      }
      .tab-view {
        display: none;
        animation: fadeIn 0.3s;
      }
      .tab-view.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .shop-step {
        display: none;
      }
      .shop-step.active {
        display: block;
      }
      .shop-indicator {
        display: flex;
        margin-bottom: 20px;
        justify-content: center;
      }
      .shop-ind-item {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        font-weight: bold;
        color: #777;
      }
      .shop-ind-item.active {
        background: #0d6efd;
        color: white;
      }
      #webhook-console {
        background: #1e1e1e;
        color: #00ff00;
        font-family: "Courier New", Courier, monospace;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        border-radius: 5px;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <nav class="sidebar">
      <a href="#" class="brand"><i class="fas fa-boxes"></i> Tapsilat Python</a>
      <div class="nav flex-column">
        <a class="nav-link active" onclick="switchView('shop', this)"
          ><i class="fas fa-shopping-cart me-2"></i> New Order</a
        >
        <a class="nav-link" onclick="switchView('orders', this)"
          ><i class="fas fa-list me-2"></i> Order List</a
        >
        <a class="nav-link" onclick="switchView('subscriptions', this)"
          ><i class="fas fa-sync me-2"></i> Subscriptions</a
        >
        <a class="nav-link" onclick="switchView('terms', this)"
          ><i class="fas fa-file-invoice-dollar me-2"></i> Payment Terms</a
        >
        <a class="nav-link" onclick="switchView('submerchants', this)"
          ><i class="fas fa-store me-2"></i> Submerchants</a
        >
        <a class="nav-link" onclick="switchView('organization', this)"
          ><i class="fas fa-building me-2"></i> Organization</a
        >
        <a class="nav-link" onclick="switchView('webhooks', this)"
          ><i class="fas fa-broadcast-tower me-2"></i> Webhook Monitor</a
        >
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- SHOP VIEW -->
      <div id="view-shop" class="tab-view active">
        <h2>Create New Order</h2>
        <div class="card p-4">
          <div class="shop-indicator">
            <div class="shop-ind-item active" id="si-1">1</div>
            <div class="shop-ind-item" id="si-2">2</div>
            <div class="shop-ind-item" id="si-3">3</div>
          </div>

          <!-- 1. Cart & Options -->
          <div id="shop-step-1" class="shop-step active">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4>Order Details & Settings</h4>
              <button
                class="btn btn-sm btn-outline-secondary"
                onclick="randomizeShopValues()"
              >
                <i class="fas fa-random"></i> Randomize
              </button>
            </div>

            <!-- Core Settings -->
            <div class="card mb-3">
              <div class="card-header bg-light">General Settings</div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Conversation ID</label>
                    <input type="text" class="form-control" id="shop-conv-id" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="shop-desc" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Locale</label>
                    <select class="form-select" id="shop-locale">
                      <option value="tr">TR</option>
                      <option value="en">EN</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Currency</label>
                    <select class="form-select" id="shop-currency">
                      <option value="TRY">TRY</option>
                      <option value="USD">USD</option>
                      <option value="EUR">EUR</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">3D Secure</label>
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="shop-3d"
                        checked
                      />
                      <label class="form-check-label">Force 3D</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Installment</label>
                    <input
                      type="number"
                      class="form-control"
                      id="shop-installment-count"
                      value="1"
                    />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">All Pay Methods</label>
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="shop-pm"
                        checked
                      />
                      <label class="form-check-label">Enable All</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Advanced Settings -->
            <div class="card mb-3">
              <div class="card-header bg-light">Advanced Configuration</div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label">Enabled Installments</label>
                    <div
                      id="shop-installments-checks"
                      class="d-flex gap-3 flex-wrap"
                    >
                      <!-- JS Injected -->
                    </div>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Payment Options</label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          value="card"
                          id="po-card"
                          checked
                        />
                        <label class="form-check-label" for="po-card"
                          >Card</label
                        >
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          value="bank_transfer"
                          id="po-bank"
                          checked
                        />
                        <label class="form-check-label" for="po-bank"
                          >Bank Transfer</label
                        >
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Metadata (Key:Value)</label>
                    <div id="shop-metadata-list" class="mb-2"></div>
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      onclick="addMetadataRow()"
                    >
                      + Add Metadata
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-3">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <span>Basket Items</span>
                <button
                  class="btn btn-sm btn-outline-primary"
                  onclick="addCartItem()"
                >
                  + Add Item
                </button>
              </div>
              <div class="card-body p-0">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Product Name</th>
                      <th style="width: 120px">Price</th>
                      <th style="width: 80px">Qty</th>
                      <th style="width: 50px"></th>
                    </tr>
                  </thead>
                  <tbody id="cart-items-body"></tbody>
                </table>
              </div>
            </div>

            <div class="text-end border-top pt-3">
              <h4 class="mb-3">
                Total: <span id="cart-total-display">₺0.00</span>
              </h4>
              <button class="btn btn-primary" onclick="validateStep1()">
                Proceed to Address
              </button>
            </div>
          </div>

          <!-- 2. Address -->
          <div id="shop-step-2" class="shop-step">
            <h4>Billing Information</h4>
            <form id="billing-form">
              <div class="row">
                <div class="col-md-6 mb-2">
                  <input
                    class="form-control"
                    name="contact_name"
                    value="John Doe"
                    placeholder="Name"
                  />
                </div>
                <div class="col-md-6 mb-2">
                  <input
                    class="form-control"
                    name="email"
                    value="john@example.com"
                    placeholder="Email"
                  />
                </div>
                <div class="col-md-6 mb-2">
                  <input
                    class="form-control"
                    name="contact_phone"
                    value="5551234567"
                    placeholder="Phone"
                  />
                </div>
                <div class="col-md-6 mb-2">
                  <input
                    class="form-control"
                    name="vat_number"
                    value="11111111111"
                    placeholder="VAT/Identity"
                  />
                </div>
                <div class="col-12 mb-2">
                  <input
                    class="form-control"
                    name="address"
                    value="Besiktas Main St"
                    placeholder="Address"
                  />
                </div>
                <div class="col-6 mb-2">
                  <input
                    class="form-control"
                    name="city"
                    value="Istanbul"
                    placeholder="City"
                  />
                </div>
                <div class="col-6 mb-2">
                  <input
                    class="form-control"
                    name="zip_code"
                    value="34000"
                    placeholder="Zip"
                  />
                </div>
                <div class="col-12 mt-2">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="same-address"
                      checked
                    />
                    <label class="form-check-label" for="same-address">
                      Shipping address same as billing
                    </label>
                  </div>
                </div>
              </div>
            </form>
            <button class="btn btn-secondary" onclick="toShopStep(1)">
              Back
            </button>
            <button class="btn btn-primary" onclick="toShopStep(3)">
              Proceed to Payment
            </button>
          </div>

          <!-- 3. Payment -->
          <div id="shop-step-3" class="shop-step">
            <h4>Payment Options</h4>
            <div class="mb-3">
              <label>Installments:</label>
              <select class="form-select" id="shop-installment">
                <option value="1">Cash (1)</option>
                <option value="2">2 Installments</option>
                <option value="3">3 Installments</option>
                <option value="6">6 Installments</option>
                <option value="12">12 Installments</option>
              </select>
            </div>
            <button class="btn btn-secondary" onclick="toShopStep(2)">
              Back
            </button>
            <button class="btn btn-success" onclick="createOrder()">
              Complete Order
            </button>
          </div>
        </div>
      </div>

      <!-- ORDERS VIEW -->
      <div id="view-orders" class="tab-view">
        <h2 class="d-flex justify-content-between align-items-center">
          Order Management
          <button class="btn btn-primary btn-sm" onclick="fetchOrders()">
            Refresh List
          </button>
        </h2>

        <!-- Filter Bar -->
        <div class="card p-3 mb-3 bg-light">
          <form
            onsubmit="
              event.preventDefault();
              fetchOrders(1);
            "
          >
            <div class="row g-2">
              <div class="col-md-3">
                <label>Date Range</label>
                <div class="input-group">
                  <input
                    type="date"
                    class="form-control form-control-sm"
                    id="filter-start"
                  />
                  <input
                    type="date"
                    class="form-control form-control-sm"
                    id="filter-end"
                  />
                </div>
              </div>
              <div class="col-md-2">
                <label>Org ID</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="filter-org"
                  placeholder="Organization ID"
                />
              </div>
              <div class="col-md-2">
                <label>Related Ref ID</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="filter-ref"
                  placeholder="Ref ID"
                />
              </div>
              <div class="col-md-2">
                <label>Page</label>
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    class="form-control"
                    id="order-page"
                    value="1"
                    min="1"
                  />
                  <select class="form-select" id="order-per-page">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-secondary btn-sm w-100">
                  Apply Filters
                </button>
              </div>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Reference ID</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="orders-table-body">
                  <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                      Loading...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-between">
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="changeOrderPage(-1)"
            >
              Previous
            </button>
            <span id="order-page-info">Page 1</span>
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="changeOrderPage(1)"
            >
              Next
            </button>
          </div>
        </div>

        <!-- Detail Modal -->
        <div class="modal fade" id="orderDetailModal" tabindex="-1">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  Order Details:
                  <span
                    id="detail-id"
                    class="text-primary font-monospace"
                  ></span>
                </h5>
                <button
                  class="btn btn-sm btn-outline-secondary ms-2"
                  onclick="copyText('detail-id')"
                >
                  <i class="fas fa-copy"></i>
                </button>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>
              <div class="modal-body">
                <!-- Management Actions -->
                <div
                  class="alert alert-light border d-flex gap-2 justify-content-end mb-4"
                >
                  <button
                    class="btn btn-danger btn-sm"
                    onclick="actionOrder('cancel')"
                  >
                    <i class="fas fa-ban"></i> Cancel Order
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    onclick="actionOrder('refund')"
                  >
                    <i class="fas fa-undo"></i> Refund Order
                  </button>
                </div>

                <div class="row">
                  <!-- Basic Info -->
                  <div class="col-md-6 mb-4">
                    <h6>Basic Info</h6>
                    <table class="table table-sm table-bordered">
                      <tbody id="detail-basic"></tbody>
                    </table>
                  </div>
                  <!-- Raw Data -->
                  <div class="col-md-6 mb-4">
                    <h6>Raw Data</h6>
                    <pre
                      id="detail-raw"
                      style="max-height: 200px; font-size: 0.8em"
                    ></pre>
                  </div>
                </div>

                <!-- Transactions -->
                <h6 class="border-bottom pb-2 mt-2">Transactions</h6>
                <div id="detail-transactions" class="mb-4 text-muted">
                  Loading transactions...
                </div>

                <!-- Terms -->
                <h6 class="border-bottom pb-2 mt-2">Payment Terms</h6>
                <div class="text-end mb-2">
                  <button
                    class="btn btn-sm btn-success"
                    data-bs-toggle="collapse"
                    data-bs-target="#new-term-form"
                  >
                    + Add Term
                  </button>
                </div>
                <div class="collapse mb-3" id="new-term-form">
                  <div class="card card-body bg-light">
                    <form onsubmit="createTerm(event)">
                      <div class="input-group">
                        <input
                          type="number"
                          name="amount"
                          class="form-control"
                          placeholder="Amount"
                          step="0.01"
                          required
                        />
                        <input
                          type="date"
                          name="due_date"
                          class="form-control"
                          required
                        />
                        <button class="btn btn-primary">Create</button>
                      </div>
                    </form>
                  </div>
                </div>
                <div id="detail-terms" class="mb-4 text-muted">
                  Fetch terms manually if needed (API limited on pure list)
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SUBSCRIPTIONS VIEW -->
      <div id="view-subscriptions" class="tab-view">
        <h2>Subscriptions</h2>
        <div class="row">
          <div class="col-md-4">
            <div class="card p-3">
              <h4>New Subscription</h4>
              <form onsubmit="createSubscription(event)">
                <input
                  class="form-control mb-2"
                  name="name"
                  value="Gold Plan"
                  placeholder="Title"
                  required
                />
                <input
                  type="number"
                  class="form-control mb-2"
                  name="amount"
                  value="49.90"
                  step="0.01"
                  placeholder="Amount"
                  required
                />
                <select class="form-select mb-3" name="period">
                  <option value="1">Monthly</option>
                  <option value="12">Yearly</option>
                </select>
                <button class="btn btn-primary w-100">Create & Pay</button>
              </form>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card p-3">
              <h4>
                List
                <button
                  class="btn btn-sm btn-light float-end"
                  onclick="fetchSubscriptions()"
                >
                  Refresh
                </button>
              </h4>
              <div id="subs-list" class="list-group list-group-flush">
                <div class="text-center py-3">Loading...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TERMS VIEW (Direct) -->
      <div id="view-terms" class="tab-view">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Payment Terms Scanner</h2>
          <button class="btn btn-primary" onclick="fetchTerms()">
            Scan Last 100 Orders
          </button>
        </div>
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Term Ref ID</th>
                    <th>Order Ref ID</th>
                    <th>Amount</th>
                    <th>Required</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="terms-table-body">
                  <tr>
                    <td colspan="6" class="text-center">
                      Click "Scan" to load terms from recent orders.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- SUBMERCHANTS VIEW -->
      <div id="view-submerchants" class="tab-view">
        <h2 class="d-flex justify-content-between align-items-center mb-3">
          Submerchants
          <button class="btn btn-primary btn-sm" onclick="fetchSubmerchants()">
            Refresh List
          </button>
        </h2>
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Submerchant ID</th>
                    <th>Type</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="submerchants-table-body">
                  <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                      Loading...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-secondary" disabled>
              Previous
            </button>
            <span>Page 1</span>
            <button class="btn btn-sm btn-outline-secondary" disabled>
              Next
            </button>
          </div>
        </div>
      </div>

      <!-- ORGANIZATION VIEW -->
      <div id="view-organization" class="tab-view">
        <h2 class="mb-4">Organization Settings</h2>
        <div class="card">
          <div class="card-body" id="org-settings-body">
            <div class="text-center py-5">Loading settings...</div>
          </div>
        </div>
      </div>

      <!-- WEBHOOK MONITOR -->
      <div id="view-webhooks" class="tab-view">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Webhook Monitor</h2>
          <button class="btn btn-secondary" onclick="fetchWebhooks()">
            <i class="fas fa-sync-alt"></i> Refresh List
          </button>
        </div>
        <p class="text-muted">
          Webhooks are saved to `webhooks/` folder. Click refresh to list them.
        </p>
        <div class="card">
          <div class="card-header bg-dark text-white">Received Callbacks</div>
          <div
            class="card-body p-0"
            id="webhook-list"
            style="height: 500px; overflow-y: auto"
          >
            <div class="p-4 text-center text-muted">
              Click Refresh to load data.
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- UTILS ---
      const show = (id) => document.getElementById(id).classList.remove("d-none");
      const hide = (id) => document.getElementById(id).classList.add("d-none");
      const copyText = (id) => {
        const text = document.getElementById(id).innerText || document.getElementById(id).value;
        navigator.clipboard.writeText(text);
        alert("Copied: " + text);
      };

      // --- NAVIGATION ---
      function switchView(viewName, el) {
        console.log(`[Navigation] Switching to view: ${viewName}`);
        document.querySelectorAll(".sidebar .nav-link").forEach((el) => el.classList.remove("active"));
        if (el) el.classList.add("active");
        document.querySelectorAll(".tab-view").forEach((el) => el.classList.remove("active"));
        document.getElementById("view-" + viewName).classList.add("active");

        if (viewName === "orders") fetchOrders();
        if (viewName === "subscriptions") fetchSubscriptions();
        if (viewName === "terms") fetchTerms();
        if (viewName === "submerchants") fetchSubmerchants();
        if (viewName === "organization") fetchOrganizationSettings();
        if (viewName === "shop") {
          renderCart();
          initShopUI();
        }
      }

      // --- SHOP LOGIC ---
      let cart = [{ id: 1, name: "Premium Widget", price: 100.0, quantity: 1 }];
      function renderCart() {
        const tbody = document.getElementById("cart-items-body");
        tbody.innerHTML = "";
        let total = 0;
        cart.forEach((item, index) => {
          total += item.price * item.quantity;
          tbody.innerHTML += `
              <tr>
                  <td><input type="text" class="form-control form-control-sm" value="${item.name}" onchange="updateCartItem(${index}, 'name', this.value)"></td>
                  <td><input type="number" class="form-control form-control-sm" value="${item.price}" onchange="updateCartItem(${index}, 'price', this.value)"></td>
                  <td><input type="number" class="form-control form-control-sm" value="${item.quantity}" min="1" onchange="updateCartItem(${index}, 'quantity', this.value)"></td>
                  <td><button class="btn btn-sm btn-link text-danger" onclick="removeCartItem(${index})"><i class="fas fa-trash"></i></button></td>
              </tr>`;
        });
        if (cart.length === 0) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Cart is empty</td></tr>';
        document.getElementById("cart-total-display").innerText = "₺" + total.toFixed(2);
      }
      function addCartItem() {
        const id = cart.length > 0 ? Math.max(...cart.map((i) => i.id)) + 1 : 1;
        cart.push({ id: id, name: "New Product", price: 50.0, quantity: 1 });
        renderCart();
      }
      function removeCartItem(index) {
        cart.splice(index, 1);
        renderCart();
      }
      function updateCartItem(index, field, value) {
        if (field === "price" || field === "quantity") cart[index][field] = parseFloat(value);
        else cart[index][field] = value;
        renderCart();
      }
      function validateStep1() {
        if (cart.length === 0) { alert("Cart cannot be empty!"); return; }
        toShopStep(2);
      }
      function toShopStep(step) {
        console.log(`[Shop] Moved to step ${step}`);
        document.querySelectorAll(".shop-step").forEach((el) => el.classList.remove("active"));
        document.getElementById("shop-step-" + step).classList.add("active");
        for (let i = 1; i <= 3; i++) {
          const el = document.getElementById("si-" + i);
          if (i <= step) el.classList.add("active");
          else el.classList.remove("active");
        }
      }
      const possibleInstallments = [1, 2, 3, 6, 9, 12];
      function initShopUI() {
        const instDiv = document.getElementById("shop-installments-checks");
        instDiv.innerHTML = possibleInstallments.map((i) => `
           <div class="form-check">
               <input class="form-check-input inst-check" type="checkbox" value="${i}" id="inst-${i}" checked>
               <label class="form-check-label" for="inst-${i}">${i}</label>
           </div>`).join("");
        randomizeShopValues();
      }
      function addMetadataRow(key = "", val = "") {
        const div = document.createElement("div");
        div.className = "input-group mb-1 metadata-row";
        div.innerHTML = `
            <input type="text" class="form-control form-control-sm" placeholder="Key" value="${key}">
            <input type="text" class="form-control form-control-sm" placeholder="Value" value="${val}">
            <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">x</button>
        `;
        document.getElementById("shop-metadata-list").appendChild(div);
      }
      function randomizeShopValues() {
        document.getElementById("shop-conv-id").value = "CONV_" + Math.random().toString(36).substr(2, 9).toUpperCase();
        document.getElementById("shop-desc").value = "Order via Python Dashboard";
        document.getElementById("shop-metadata-list").innerHTML = "";
        addMetadataRow("source", "dashboard");
        addMetadataRow("client", "web");
      }

      async function createOrder() {
        const form = document.getElementById("billing-form");
        const formData = new FormData(form);
        const billing = Object.fromEntries(formData.entries());
        const enabledInst = Array.from(document.querySelectorAll(".inst-check:checked")).map(e => parseInt(e.value));
        const payOptions = [
          document.getElementById("po-card").checked ? "card" : null,
          document.getElementById("po-bank").checked ? "bank_transfer" : null,
        ].filter(Boolean);
        const metadata = Array.from(document.querySelectorAll(".metadata-row")).map(row => {
          const inputs = row.querySelectorAll("input");
          return { key: inputs[0].value, value: inputs[1].value };
        }).filter(m => m.key);

        const requestData = {
          cart: cart,
          billing: billing,
          same_address: document.getElementById("same-address").checked,
          installment: parseInt(document.getElementById("shop-installment").value),
          currency: document.getElementById("shop-currency").value,
          locale: document.getElementById("shop-locale").value,
          description: document.getElementById("shop-desc").value,
          conversation_id: document.getElementById("shop-conv-id").value,
          force_3d: document.getElementById("shop-3d").checked,
          enabled_installments: enabledInst,
          payment_options: payOptions,
          metadata: metadata
        };

        try {
          const res = await fetch("/api/order/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData)
          });
          const json = await res.json();
          if (json.checkout_url) {
            window.location.href = json.checkout_url;
          } else {
            alert("Order Created! Ref: " + json.reference_id + "\n(No Checkout URL returned)");
          }
        } catch (err) {
          alert("Error: " + err.message);
        }
      }

      // --- ORDER LIST Logic ---
      let currentOrderPage = 1;
      async functionfetchOrders(pageOverride) {
        if (pageOverride) currentOrderPage = pageOverride;
        const tbody = document.getElementById("orders-table-body");
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

        const perPage = document.getElementById("order-per-page").value;
        const startDate = document.getElementById("filter-start").value;
        const endDate = document.getElementById("filter-end").value;
        const orgId = document.getElementById("filter-org").value;
        const refId = document.getElementById("filter-ref").value;

        const params = new URLSearchParams({
          page: currentOrderPage,
          per_page: perPage,
          start_date: startDate,
          end_date: endDate,
          organization_id: orgId,
          related_reference_id: refId
         });

        try {
          const res = await fetch("/api/order/list?" + params);
          const json = await res.json();
          if (!json.items || json.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No orders found.</td></tr>';
            document.getElementById("order-page-info").innerText = `Page ${currentOrderPage}`;
            return;
          }
          tbody.innerHTML = json.items.map(o => `
              <tr>
                  <td class="font-monospace">${o.reference_id}</td>
                  <td>${o.created_at || "-"}</td>
                  <td>${o.amount} ${o.currency}</td>
                  <td><span class="badge bg-${o.status === 'Paid' ? 'success' : 'secondary'}">${o.status}</span></td>
                  <td><button class="btn btn-sm btn-info" onclick="openOrderDetail('${o.reference_id}')">View</button></td>
              </tr>
          `).join("");
          document.getElementById("order-page-info").innerText = `Page ${currentOrderPage}`;
        } catch (e) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${e.message}</td></tr>`;
        }
      }
      function changeOrderPage(dir) {
        if (currentOrderPage + dir < 1) return;
        currentOrderPage += dir;
        fetchOrders();
      }

      // --- ORDER DETAIL Logic ---
      let currentDetailRefId = null;
      async function openOrderDetail(refId) {
        currentDetailRefId = refId;
        const modal = new bootstrap.Modal(document.getElementById("orderDetailModal"));
        modal.show();
        document.getElementById("detail-id").innerText = refId;
        document.getElementById("detail-basic").innerHTML = "<tr><td colspan='2'>Loading...</td></tr>";
        document.getElementById("detail-raw").innerText = "";
        document.getElementById("detail-transactions").innerText = "Loading...";

        // Fetch details
        try {
          const res = await fetch(`/api/order/${refId}`);
          const data = await res.json();

          // Basic Info Table
          const basicHTML = `
              <tr><th>Status</th><td>${data.status}</td></tr>
              <tr><th>Amount</th><td>${data.amount} ${data.currency}</td></tr>
              <tr><th>Buyer</th><td>${data.buyer ? (data.buyer.name + " " + data.buyer.surname) : "-"}</td></tr>
              <tr><th>Conversation ID</th><td>${data.conversation_id}</td></tr>
              <tr><th>Created At</th><td>${data.created_at}</td></tr>
          `;
          document.getElementById("detail-basic").innerHTML = basicHTML;
          document.getElementById("detail-raw").innerText = JSON.stringify(data, null, 2);

          // Fetch Transactions
          const trxRes = await fetch(`/api/order/${refId}/transactions`); // Assuming endpoint exists
          // If not checking status
          const statusRes = await fetch(`/api/order/${refId}/status`);
          const statusJson = await statusRes.json();
          // Just show status raw for now
          document.getElementById("detail-transactions").innerText = JSON.stringify(statusJson, null, 2);

        } catch (e) {
          document.getElementById("detail-basic").innerText = "Error loading details.";
        }
      }

      async function actionOrder(action) {
        if (!currentDetailRefId || !confirm(`Are you sure you want to ${action} this order?`)) return;
        try {
          const res = await fetch(`/api/order/${action}`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ reference_id: currentDetailRefId })
          });
          const json = await res.json();
          alert(action.toUpperCase() + " Result: " + JSON.stringify(json));
          openOrderDetail(currentDetailRefId); // Refresh
        } catch (e) { alert("Error: " + e.message); }
      }

      // --- SUBSCRIPTION Logic ---
      async function fetchSubscriptions() {
          const div = document.getElementById("subs-list");
          div.innerHTML = "Loading...";
          try {
              const res = await fetch("/api/subscription/list");
              const json = await res.json();
              if (!json.items || json.items.length === 0) {
                  div.innerHTML = "No subscriptions found."; return;
              }
              div.innerHTML = json.items.map(s => `
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                          <h5 class="mb-1">${s.title || "Sub"} (${s.reference_id})</h5>
                          <small>Status: ${s.status} | Period: ${s.period}</small>
                      </div>
                      <div>
                          ${s.status !== 'Canceled' ?
                              `<button class="btn btn-sm btn-danger" onclick="cancelSubscription('${s.reference_id}')">Cancel</button>` :
                              '<span class="badge bg-secondary">Canceled</span>'}
                      </div>
                  </div>
              `).join("");
          } catch(e) { div.innerHTML = "Error: " + e.message; }
      }

      async function createSubscription(e) {
          e.preventDefault();
          const form = e.target;
          const data = {
              title: form.name.value,
              amount: parseFloat(form.amount.value),
              period: parseInt(form.period.value),
              currency: "TRY"
          };
          try {
              const res = await fetch("/api/subscription/create", {
                  method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(data)
              });
              const json = await res.json();
              if (json.checkout_url) window.location.href = json.checkout_url;
              else alert("Subscription created: " + JSON.stringify(json));
          } catch(e) { alert("Error: " + e.message); }
      }

      async function cancelSubscription(refId) {
          if(!confirm("Cancel subscription?")) return;
          try {
              await fetch("/api/subscription/cancel", {
                  method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({reference_id: refId})
              });
              fetchSubscriptions();
          } catch(e) { alert("Error: " + e.message); }
      }

      // --- TERMS LOGIC ---
      // (Stub implementation for brevity, mirror what PHP example does)
      async function fetchTerms() {
           const tbody = document.getElementById("terms-table-body");
           tbody.innerHTML = "<tr><td colspan='6' class='text-center'>Scanning orders (mock)...</td></tr>";
           // In a real app we'd fetch from an endpoint. For now, let's just show mock or empty.
           setTimeout(() => {
               tbody.innerHTML = "<tr><td colspan='6' class='text-center'>No terms found in recent scan.</td></tr>";
           }, 500);
      }
      async function createTerm(e) {
          e.preventDefault();
          alert("Create term feature requires order context. Go to Order Details -> Add Term.");
      }

      // --- SUBMERCHANTS LOGIC ---
      async function fetchSubmerchants() {
        const tbody = document.getElementById("submerchants-table-body");
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
        try {
          const res = await fetch("/api/order/submerchants?page=1&per_page=10");
          const json = await res.json();
          const rows = json.items || json.rows || [];
          if (!rows || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No submerchants found.</td></tr>';
            return;
          }
          tbody.innerHTML = rows.map(s => `
                  <tr>
                      <td class="font-monospace">${s.submerchant_id || s.reference_id || "-"}</td>
                      <td>${s.type || "PERSONAL"}</td>
                      <td>${s.name || "-"}</td>
                      <td>${s.email || "-"}</td>
                      <td><span class="badge bg-${s.status === 1 ? 'success' : 'secondary'}">${s.status === 1 ? 'Active' : 'Inactive'}</span></td>
                  </tr>
              `).join("");
        } catch (e) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${e.message}</td></tr>`;
        }
      }

      // --- ORGANIZATION LOGIC ---
      async function fetchOrganizationSettings() {
        const div = document.getElementById("org-settings-body");
        div.innerHTML = "Loading...";
        try {
          const res = await fetch("/api/organization/settings");
          const json = await res.json();
          div.innerHTML = `
                  <table class="table table-bordered">
                      <tr><th style="width:200px">Organization ID</th><td>${json.organization_id || "-"}</td></tr>
                      <tr><th>Name</th><td>${json.name || "-"}</td></tr>
                      <tr><th>Status</th><td>${json.status || "-"}</td></tr>
                      <tr><th>Created At</th><td>${json.created_at || "-"}</td></tr>
                  </table>
                `;
        } catch (e) {
          div.innerHTML = `<div class="alert alert-danger">Error loading settings: ${e.message}</div>`;
        }
      }
    </script>
  </body>
</html>
